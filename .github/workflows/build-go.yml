on:
  workflow_call:
    secrets:
      SLACK_BOT_TOKEN:
        required: true
      GO_PRIVATE_REPO_KEY:
        required: true
    inputs:
      coverage-threshold:
        description: Minimum percentage of code covered by tests for build to pass
        type: number
        required: false
        default: 75.0
      golang-version:
        description: Version of golang used to build application
        required: false
        type: string
      requires-postgres:
        type: boolean
        required: false
      requires-cassandra:
        type: boolean
        required: false
      requires-redis:
        type: boolean
        required: false
      requires-vault:
        type: boolean
        required: false
      requires-clickhouse:
        type: boolean
        required: false

jobs:
  required:
    name: Compile Services Configuration
    env:
      POSTGRES: >-
        "postgres": {
        "image": "postgres:11.4",
        "env": {
        "POSTGRES_DB": "postgres",
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "postgres",
        "POSTGRES_PORT": 5432},
        "ports": ["5432:5432"],
        "options": "--health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5"
        }
      CASSANDRA: >-
        "cassandra": {
        "image": "cassandra:3.11.12",
        "env": {
        "CASSANDRA_CLUSTER_NAME": "cassandracluster",
        "JVM_OPTS": "-Xms512M -Xmx512M",
        "MAX_HEAP_SIZE": "512M",
        "HEAP_NEWSIZE": "128M"},
        "ports":["9042:9042"],
        "options": "--health-cmd \"cqlsh --debug\" --health-interval 10s --health-timeout 5s --health-retries 5"
        }
      REDIS: >-
        "redis": {
        "image": "redis:5.0.14",
        "ports":["6379:6379"],
        "options": "--health-cmd \"redis-cli ping\" --health-interval 10s --health-timeout 5s --health-retries 5"
        }
      VAULT: >-
        "vault": {
        "image": "vault:1.13.3",
        "env": {
        "VAULT_ADDR": "http://0.0.0.0:8200",
        "VAULT_DEV_ROOT_TOKEN_ID": "vault-root-token"},
        "ports":["8200:8200"],
        "options": "--health-cmd \"vault version\" --health-interval 10s --health-timeout 5s --health-retries 5"
        }
      CLICKHOUSE: >-
        "clickhouse": {
        "image": "toggleglobal/clickhouse-server:22.3",
        "ports":["9000:9000"],
        "options": "--health-cmd \"clickhouse status\" --health-interval 10s --health-timeout 5s --health-retries 5"
        }
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.required.outputs.services }}
    steps:
      - name: Requires Postgres
        if: inputs.requires-postgres
        run: |
          if [[ -z '${{ env.SERVICES }}' ]]; then
            echo 'SERVICES=${{env.SERVICES}}${{env.POSTGRES}}' >> $GITHUB_ENV
          else
            echo 'SERVICES=${{env.SERVICES}},${{env.POSTGRES}}' >> $GITHUB_ENV
          fi
      - name: Requires Cassandra
        if: inputs.requires-cassandra
        run: |
          if [[ -z '${{ env.SERVICES }}' ]]; then
            echo 'SERVICES=${{env.SERVICES}}${{env.CASSANDRA}}' >> $GITHUB_ENV
          else
            echo 'SERVICES=${{env.SERVICES}},${{env.CASSANDRA}}' >> $GITHUB_ENV
          fi
      - name: Requires Redis
        if: inputs.requires-redis
        run: |
          if [[ -z '${{ env.SERVICES }}' ]]; then
            echo 'SERVICES=${{env.SERVICES}}${{env.REDIS}}' >> $GITHUB_ENV
          else
            echo 'SERVICES=${{env.SERVICES}},${{env.REDIS}}' >> $GITHUB_ENV
          fi
      - name: Requires Vault
        if: inputs.requires-vault
        run: |
          if [[ -z '${{ env.SERVICES }}' ]]; then
            echo 'SERVICES=${{env.SERVICES}}${{env.VAULT}}' >> $GITHUB_ENV
          else
            echo 'SERVICES=${{env.SERVICES}},${{env.VAULT}}' >> $GITHUB_ENV
          fi
      - name: Requires ClickHouse
        if: inputs.requires-clickhouse
        run: |
          if [[ -z '${{ env.SERVICES }}' ]]; then
            echo 'SERVICES=${{env.SERVICES}}${{env.CLICKHOUSE}}' >> $GITHUB_ENV
          else
            echo 'SERVICES=${{env.SERVICES}},${{env.CLICKHOUSE}}' >> $GITHUB_ENV
          fi
      - id: required
        run: |
          echo services='{${{env.SERVICES}}}' >> $GITHUB_OUTPUT

      - name: display string
        run: |
          echo "::notice ::Requires Postgres: ${{ inputs.requires-postgres }}"
          echo "::notice ::Requires Cassandra: ${{ inputs.requires-cassandra }}"
          echo "::notice ::Requires Redis: ${{ inputs.requires-redis }}"
          echo "::notice ::Requires Vault: ${{ inputs.requires-vault }}"
          echo "::notice ::Requires ClickHouse: ${{ inputs.requires-clickhouse }}"

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: required
    services: ${{fromJSON(needs.required.outputs.services)}}
    env:
      POSTGRES_CONN_URI: "postgres://localhost:5432/postgres?user=postgres&password=postgres&sslmode=disable"
      POSTGRES_MIGRATIONS: ../../db/migrations/postgres
      CASSANDRA_CLUSTER_HOSTS: localhost
      CASSANDRA_PORT: 9042
      CASSANDRA_KEYSPACE: svc_test
      CASSANDRA_MIGRATIONS: ../../db/migrations/cassandra
      CASSANDRA_PASSWORD: cassandra
      CASSANDRA_USER: cassandra
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_DEV_TOKEN_ID: vault-root-token
      CLICKHOUSE_CONN_URI: "clickhouse://localhost:9000/default?username=default"
      CLICKHOUSE_MIGRATIONS: ../../db/migrations/clickhouse
      GOLANG_VERSION: ${{ inputs.golang-version }}
      GOPRIVATE: github.com/toggleglobal/*
      SSH_AUTH_SOCK: /tmp/ssh_agent.sock
      LOCALAZY_READ_KEY: ${{ secrets.LOCALAZY_READ_KEY }}
      LOCALAZY_WRITE_KEY: ${{ secrets.LOCALAZY_WRITE_KEY }}
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Checkout Config
      # Checkout workflow repo to gain access to config file
      uses: actions/checkout@v3
      with:
        repository: toggleglobal/workflows
        path: './tmp'
        ref: main

    - name: Set Default Golang Build Version
      if: env.GOLANG_VERSION == ''
      run: |
        echo "GOLANG_VERSION=$(yq -r '.golang.build.version' ./tmp/config.yml)" >> $GITHUB_ENV

    - name: Setup SSH and git
      run: |
        mkdir -p -m 0700 "$HOME/.ssh"
        ssh-keyscan -H github.com >> $HOME/.ssh/known_hosts
        ssh-agent -a $SSH_AUTH_SOCK > /dev/null
        ssh-add - <<< "${{ secrets.GO_PRIVATE_REPO_KEY }}"
        git config --global url."git@github.com:toggleglobal".insteadOf https://github.com/toggleglobal

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GOLANG_VERSION }}
        check-latest: false

    - name: Install wire
      run: go install github.com/google/wire/cmd/wire@v0.5.0

    - name: Check Wire
      run: |
        find . -type f -name "wire.go" -execdir wire \;
        if git status --porcelain | grep -q "wire_gen.go"
        then
          echo "wire_gen.go is out of date; run wire locally then push your branch again."
          exit 1
        fi

    - name: Install goimports
      run: go install golang.org/x/tools/cmd/goimports@latest

    - name: Verify formatting
      run: |
        ISSUES=$(goimports -l -e . 2>&1)
        has_issues=false
        while read -r issue; do
          if [[ -n "$issue" ]]; then
            if [[ ! $issue =~ ^\.templates/ ]]; then
              if [[ ! $issue =~ (_gen|_enumer|\.pb)\.go$ ]]; then
                echo "$issue"
                has_issues=true
              fi
            fi
          fi
        done <<< "$ISSUES"
        if [ "$has_issues" = true ]; then
          echo "One or more files appeared to be malformatted; run goimports locally then push your branch again."
          exit 1
        fi
        exit 0

    - name: Verify dependencies
      run: go mod verify

    - name: Build
      run: go build -v ./...

    - name: Run go vet
      run: go vet ./...

    - name: Install staticcheck
      run: go install honnef.co/go/tools/cmd/staticcheck@2023.1.3

    - name: Run staticcheck
      run: staticcheck ./...

    - name: Extract source strings
      if: env.LOCALAZY_READ_KEY != '' && env.LOCALAZY_WRITE_KEY != ''
      run: |
        go install github.com/toggleglobal/germ-i18n-extract@latest &&
        germ-i18n-extract -out ./locales .

    - name: Upload source strings to Localazy
      if: env.LOCALAZY_READ_KEY != '' && env.LOCALAZY_WRITE_KEY != ''
      uses: localazy/upload@v1
      with:
        config_file: './tmp/localazy.go.json'
        read_key: ${{ env.LOCALAZY_READ_KEY }}
        write_key: ${{ env.LOCALAZY_WRITE_KEY }}

    - name: Download translations from Localazy
      if: env.LOCALAZY_READ_KEY != ''
      uses: localazy/download@v1
      with:
        config_file: './tmp/localazy.go.json'
        read_key: ${{ env.LOCALAZY_READ_KEY }}

    - name: Install gotestsum
      run: go install gotest.tools/gotestsum@latest

    - name: Run tests
      run: gotestsum --no-color=false -- -race -coverprofile=cover.out -covermode=atomic -vet=off ./...

    - name: Quality Gate
      run: |
        total=`go tool cover -func=cover.out | grep total | grep -Eo '[0-9]+\.[0-9]+'`
        echo "Total test coverage = $total%"
        if (( $(echo "$total ${{ inputs.coverage-threshold }}" | awk '{print ($1 < $2)}') )); then
          echo "Quality gate failed. Coverage below minimum ${{ inputs.coverage-threshold }}%"
          exit 1
        fi
